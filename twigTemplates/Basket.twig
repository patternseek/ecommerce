<div id="component-basket">
    {{ state.intro }}

{% if this.flashMessage %}
        <strong class="message">{{ this.flashMessage }}</strong>
    <br>
{% endif %}
{% if this.flashError %}
    <strong class="error">{{ this.flashError }}</strong>
    <br>
{% endif %}
    {% if state.testMode %}
    <br><strong>TEST MODE</strong><br>
{% endif %}

<table class="basketTable">
    <thead>
    <th>Quantity</th>
    <th>Description</th>
    <th>Net per item</th>
    <th>VAT per item</th>
    </thead>
    <tbody>
    {% for lineItem in state.lineItems %}
        <tr>
            <td>{% if lineItem.quantity != null %}
                    {{ lineItem.quantity }}
                {% else %}
                    -
                {% endif %}</td>
            <td>{{ lineItem.description }}</td>
            <td>{{ state.config.currencySymbol }}{{ lineItem.netPrice|number_format(2) }}</td>
            <td style="text-wrap: none;" nowrap>
                {{ state.config.currencySymbol }}{{ lineItem.vatPerItem|number_format(2) }}
                {% if lineItem.isB2b %}
                    ( Zero rated )
                {% else %}
                    {% if lineItem.vatJurisdictionType == "local" %}
                        ( {{ state.config.countryCode|upper }} VAT )
                    {% else %}
                        {% set isEU = false %}
                        {% for cc,country in this.getEUVatCountries() %}
                            {% if lineItem.remoteVatJusrisdictionCountryCode == cc %}
                                {% set isEU = true %}
                            {% endif %}
                        {% endfor %}
                        {% if isEU %}
                            ( {{ lineItem.remoteVatJusrisdictionCountryCode|upper }} VAT )
                        {% else %}
                            ( Non EU )
                        {% endif %}
                    {% endif %}
                {% endif %}
            </td>
        </tr>
    {% endfor %}
        <tr class="topseparator">
            <td>&nbsp;</td>
            <td>&nbsp;</td>
            <td><strong>TOTAL VAT</strong></td>
            <td>{{ state.config.currencySymbol }}{{ state.vatTotal|number_format(2) }}</td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td>&nbsp;</td>
            <td><strong>TOTAL</strong></td>
            <td>{{ state.config.currencySymbol }}{{ state.total|number_format(2) }}</td>
        </tr>

    {% if not state.complete %}
        <tr class="topseperator">
            <td>
                EU VAT number
            </td>
            <td colspan="3">
                {% set validateFormBody %}
                {% if state.vatNumber %}
                    <strong>{{ state.vatNumber }}</strong>
                    <br>
                {% endif %}
                <input type="text" name="vatNumber" placeholder="EU VAT number">
                <select name="countryCode">
                    {% for cc,country in this.getEUVatCountries() %}
                        <option value="{{ cc }}"
                                {% if cc == state.config.countryCode|upper %}selected="selected"{% endif %}>{{ country }}</option>
                    {% endfor %}
                </select>
                <input type="submit" value="Update">
                {% endset %}
                {{ exec.replaceElementUsingForm( "validateVatNumber", "POST", validateFormBody, "component-basket", "vatNumberUpdate" ) }}
            </td>
        </tr>
    {% endif %}
    </tbody>


</table>

    {{ state.renderedBillingAddress }}
    
    {% if ( state.readyForPaymentInfo() ) and (not state.complete) %}
        <div class="basketPaymentProviders">
            {% for providerConfig in state.config.paymentProviders %}
                {{ this.childComponent( 
                    providerConfig.name,
                    providerConfig.componentClass,
                    {
                        'config' :              providerConfig.conf,
                        'buttonLabel' :         null,
                        'email' :               null,
                        'testMode' :            state.testMode,
                        'description' :         state.config.briefDescription,
                        'amount' :              state.total,
                        'basketReady' :         state.readyForPaymentInfo(),
                        'transactionComplete' : state.complete,
                        'address' :             this.childComponents.billingAddress.getState()
                    }
                ) }}
            {% endfor %}
        </div>
    {% elseif ( not state.readyForPaymentInfo() ) and (not state.complete) %}
        {# ... #}
    {% else %}
        <span class="error">This transaction has been completed.</span>
    {% endif %}
    
    <br clear="both">

{{ state.outro }}
</div>